import { Hono } from 'hono'\nimport { cors } from 'hono/cors'\nimport { serveStatic } from 'hono/cloudflare-workers'\n\n// Type definitions for Cloudflare bindings\ntype Bindings = {\n  DB: D1Database;\n}\n\nconst app = new Hono<{ Bindings: Bindings }>()\n\n// Enable CORS for API routes\napp.use('/api/*', cors())\n\n// Serve static files\napp.use('/static/*', serveStatic({ root: './public' }))\n\n// =============================================================================\n// AUTHENTICATION HELPERS\n// =============================================================================\n\n// Simple password hashing (in production, use bcrypt)\nconst hashPassword = (password: string): string => {\n  return `hashed_${password}_123` // Simplified for demo\n}\n\nconst verifyPassword = (password: string, hash: string): boolean => {\n  return hashPassword(password) === hash\n}\n\n// =============================================================================\n// API ROUTES\n// =============================================================================\n\n// Get all schools\napp.get('/api/schools', async (c) => {\n  return c.json([\n    { id: 'botani', name: 'Botani International School' },\n    { id: 'imperial', name: 'Imperial International School' }\n  ])\n})\n\n// User authentication\napp.post('/api/login', async (c) => {\n  const { email, password } = await c.req.json()\n  \n  try {\n    const user = await c.env.DB.prepare(\n      'SELECT * FROM users WHERE email = ?'\n    ).bind(email).first()\n    \n    if (!user || !verifyPassword(password, user.password_hash as string)) {\n      return c.json({ error: 'Invalid credentials' }, 401)\n    }\n    \n    // Return user info (excluding password)\n    const { password_hash, ...userInfo } = user\n    return c.json({ user: userInfo })\n  } catch (error) {\n    return c.json({ error: 'Login failed' }, 500)\n  }\n})\n\n// Register new user\napp.post('/api/register', async (c) => {\n  const { email, password, name, phone, role, school, student_class, parent_student_id } = await c.req.json()\n  \n  try {\n    const passwordHash = hashPassword(password)\n    \n    const result = await c.env.DB.prepare(`\n      INSERT INTO users (email, password_hash, name, phone, role, school, student_class, parent_student_id)\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n    `).bind(email, passwordHash, name, phone, role, school, student_class, parent_student_id).run()\n    \n    return c.json({ success: true, userId: result.meta.last_row_id })\n  } catch (error) {\n    return c.json({ error: 'Registration failed' }, 500)\n  }\n})\n\n// Get routes by school\napp.get('/api/routes/:school', async (c) => {\n  const school = c.req.param('school')\n  \n  try {\n    const routes = await c.env.DB.prepare(\n      'SELECT * FROM routes WHERE school = ? AND status = \"active\" ORDER BY name'\n    ).bind(school).all()\n    \n    return c.json({ routes: routes.results })\n  } catch (error) {\n    return c.json({ error: 'Failed to fetch routes' }, 500)\n  }\n})\n\n// Get route stops for a specific route\napp.get('/api/routes/:routeId/stops', async (c) => {\n  const routeId = c.req.param('routeId')\n  \n  try {\n    const stops = await c.env.DB.prepare(`\n      SELECT * FROM route_stops \n      WHERE route_id = ? \n      ORDER BY sequence_order\n    `).bind(routeId).all()\n    \n    return c.json({ stops: stops.results })\n  } catch (error) {\n    return c.json({ error: 'Failed to fetch stops' }, 500)\n  }\n})\n\n// Get available vans for a route and date\napp.get('/api/vans/available', async (c) => {\n  const { route_id, date, is_morning } = c.req.query()\n  \n  try {\n    const dayOfWeek = new Date(date as string).getDay() || 7 // Convert Sunday (0) to 7\n    \n    const vans = await c.env.DB.prepare(`\n      SELECT v.*, u.name as driver_name, u.phone as driver_phone,\n             vr.id as van_route_id\n      FROM vans v\n      JOIN users u ON v.driver_id = u.id\n      JOIN van_routes vr ON v.id = vr.van_id\n      WHERE vr.route_id = ? AND vr.day_of_week = ? AND vr.is_morning = ? AND vr.status = 'active'\n      AND v.status = 'active'\n    `).bind(route_id, dayOfWeek, is_morning === 'true' ? 1 : 0).all()\n    \n    return c.json({ vans: vans.results })\n  } catch (error) {\n    return c.json({ error: 'Failed to fetch available vans' }, 500)\n  }\n})\n\n// Create a new booking\napp.post('/api/bookings', async (c) => {\n  const { student_id, van_route_id, route_stop_id, booking_date, booked_by, special_instructions } = await c.req.json()\n  \n  try {\n    const result = await c.env.DB.prepare(`\n      INSERT INTO bookings (student_id, van_route_id, route_stop_id, booking_date, booked_by, special_instructions)\n      VALUES (?, ?, ?, ?, ?, ?)\n    `).bind(student_id, van_route_id, route_stop_id, booking_date, booked_by, special_instructions).run()\n    \n    return c.json({ success: true, bookingId: result.meta.last_row_id })\n  } catch (error) {\n    return c.json({ error: 'Failed to create booking' }, 500)\n  }\n})\n\n// Get bookings for a user\napp.get('/api/bookings/user/:userId', async (c) => {\n  const userId = c.req.param('userId')\n  \n  try {\n    const bookings = await c.env.DB.prepare(`\n      SELECT b.*, r.name as route_name, rs.stop_name, rs.pickup_time, rs.dropoff_time,\n             v.plate_number, u.name as driver_name, u.phone as driver_phone\n      FROM bookings b\n      JOIN van_routes vr ON b.van_route_id = vr.id\n      JOIN routes r ON vr.route_id = r.id\n      JOIN route_stops rs ON b.route_stop_id = rs.id\n      JOIN vans v ON vr.van_id = v.id\n      JOIN users u ON v.driver_id = u.id\n      WHERE b.student_id = ? OR b.booked_by = ?\n      ORDER BY b.booking_date DESC, rs.pickup_time\n    `).bind(userId, userId).all()\n    \n    return c.json({ bookings: bookings.results })\n  } catch (error) {\n    return c.json({ error: 'Failed to fetch bookings' }, 500)\n  }\n})\n\n// Cancel a booking\napp.put('/api/bookings/:bookingId/cancel', async (c) => {\n  const bookingId = c.req.param('bookingId')\n  \n  try {\n    await c.env.DB.prepare(\n      'UPDATE bookings SET status = \"cancelled\", updated_at = CURRENT_TIMESTAMP WHERE id = ?'\n    ).bind(bookingId).run()\n    \n    return c.json({ success: true })\n  } catch (error) {\n    return c.json({ error: 'Failed to cancel booking' }, 500)\n  }\n})\n\n// Get dashboard stats (for admins)\napp.get('/api/dashboard/:school', async (c) => {\n  const school = c.req.param('school')\n  \n  try {\n    const stats = await c.env.DB.batch([\n      c.env.DB.prepare('SELECT COUNT(*) as total FROM users WHERE school = ?').bind(school),\n      c.env.DB.prepare('SELECT COUNT(*) as total FROM vans WHERE school = ? AND status = \"active\"').bind(school),\n      c.env.DB.prepare('SELECT COUNT(*) as total FROM routes WHERE school = ? AND status = \"active\"').bind(school),\n      c.env.DB.prepare(`\n        SELECT COUNT(*) as total FROM bookings b\n        JOIN van_routes vr ON b.van_route_id = vr.id\n        JOIN routes r ON vr.route_id = r.id\n        WHERE r.school = ? AND b.booking_date >= date('now')\n      `).bind(school)\n    ])\n    \n    return c.json({\n      users: stats[0].results[0],\n      vans: stats[1].results[0], \n      routes: stats[2].results[0],\n      upcoming_bookings: stats[3].results[0]\n    })\n  } catch (error) {\n    return c.json({ error: 'Failed to fetch dashboard stats' }, 500)\n  }\n})\n\n// =============================================================================\n// WEB PAGES - Serve HTML directly without JSX to avoid corruption issues\n// =============================================================================\n\n// Main page - serve static HTML\napp.get('/', (c) => {\n  return c.html(`<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>School Van Ride - Botani & Imperial International School Ipoh</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link href=\"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <link href=\"/static/style.css\" rel=\"stylesheet\">\n</head>\n<body>\n    <div class=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100\">\n        <nav class=\"bg-white shadow-lg\">\n            <div class=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n                <div class=\"flex justify-between h-16\">\n                    <div class=\"flex items-center\">\n                        <div class=\"flex-shrink-0\">\n                            <i class=\"fas fa-bus text-2xl text-blue-600 mr-3\"></i>\n                            <span class=\"text-xl font-bold text-gray-800\">School Van Ride</span>\n                        </div>\n                    </div>\n                    <div class=\"flex items-center space-x-4\">\n                        <button id=\"loginBtn\" class=\"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700\">\n                            <i class=\"fas fa-sign-in-alt mr-2\"></i>Login\n                        </button>\n                        <button id=\"registerBtn\" class=\"bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700\">\n                            <i class=\"fas fa-user-plus mr-2\"></i>Register\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </nav>\n\n        <main class=\"max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8\">\n            <div class=\"text-center mb-12\">\n                <h1 class=\"text-4xl font-bold text-gray-900 mb-4\">\n                    Van Ride Booking System\n                </h1>\n                <p class=\"text-xl text-gray-600 mb-2\">\n                    For Botani International School & Imperial International School Ipoh\n                </p>\n                <div class=\"flex justify-center space-x-8 mt-8\">\n                    <div class=\"text-center\">\n                        <div class=\"bg-white p-6 rounded-lg shadow-md school-card\">\n                            <i class=\"fas fa-school text-4xl text-blue-600 mb-4\"></i>\n                            <h3 class=\"text-lg font-semibold\">Botani International</h3>\n                            <p class=\"text-gray-600\">School van services</p>\n                        </div>\n                    </div>\n                    <div class=\"text-center\">\n                        <div class=\"bg-white p-6 rounded-lg shadow-md school-card\">\n                            <i class=\"fas fa-graduation-cap text-4xl text-green-600 mb-4\"></i>\n                            <h3 class=\"text-lg font-semibold\">Imperial International</h3>\n                            <p class=\"text-gray-600\">School van services</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Login/Register sections -->\n            <div id=\"authSection\" class=\"hidden max-w-md mx-auto bg-white rounded-lg shadow-md p-6\">\n                <div id=\"loginForm\">\n                    <h2 class=\"text-2xl font-bold mb-4\">Login</h2>\n                    <form class=\"space-y-4\">\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Email</label>\n                            <input type=\"email\" id=\"loginEmail\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\" required />\n                        </div>\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Password</label>\n                            <input type=\"password\" id=\"loginPassword\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\" required />\n                        </div>\n                        <button type=\"submit\" class=\"w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700\">\n                            Login\n                        </button>\n                    </form>\n                    <p class=\"mt-4 text-center text-sm text-gray-600\">\n                        Don't have an account? <a href=\"#\" id=\"showRegister\" class=\"text-blue-600 hover:underline\">Register here</a>\n                    </p>\n                </div>\n\n                <div id=\"registerForm\" class=\"hidden\">\n                    <h2 class=\"text-2xl font-bold mb-4\">Register</h2>\n                    <form class=\"space-y-4\">\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Full Name</label>\n                            <input type=\"text\" id=\"regName\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500\" required />\n                        </div>\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Email</label>\n                            <input type=\"email\" id=\"regEmail\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500\" required />\n                        </div>\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Phone</label>\n                            <input type=\"tel\" id=\"regPhone\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500\" />\n                        </div>\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Password</label>\n                            <input type=\"password\" id=\"regPassword\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500\" required />\n                        </div>\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Role</label>\n                            <select id=\"regRole\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500\" required>\n                                <option value=\"\">Select Role</option>\n                                <option value=\"student\">Student</option>\n                                <option value=\"parent\">Parent</option>\n                            </select>\n                        </div>\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">School</label>\n                            <select id=\"regSchool\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500\" required>\n                                <option value=\"\">Select School</option>\n                                <option value=\"botani\">Botani International School</option>\n                                <option value=\"imperial\">Imperial International School</option>\n                            </select>\n                        </div>\n                        <div id=\"studentFields\" class=\"hidden\">\n                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Class</label>\n                            <input type=\"text\" id=\"regClass\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500\" placeholder=\"e.g., Form 4A, Year 10\" />\n                        </div>\n                        <button type=\"submit\" class=\"w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700\">\n                            Register\n                        </button>\n                    </form>\n                    <p class=\"mt-4 text-center text-sm text-gray-600\">\n                        Already have an account? <a href=\"#\" id=\"showLogin\" class=\"text-green-600 hover:underline\">Login here</a>\n                    </p>\n                </div>\n            </div>\n\n            <!-- Dashboard section -->\n            <div id=\"dashboard\" class=\"hidden\">\n                <div class=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n                    <h2 class=\"text-2xl font-bold mb-4\">Welcome, <span id=\"userName\"></span>!</h2>\n                    <div class=\"flex justify-between items-center\">\n                        <div>\n                            <p class=\"text-gray-600\">Role: <span id=\"userRole\" class=\"font-semibold\"></span></p>\n                            <p class=\"text-gray-600\">School: <span id=\"userSchool\" class=\"font-semibold\"></span></p>\n                        </div>\n                        <button id=\"logoutBtn\" class=\"bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700\">\n                            <i class=\"fas fa-sign-out-alt mr-2\"></i>Logout\n                        </button>\n                    </div>\n                </div>\n\n                <!-- Booking section -->\n                <div class=\"grid md:grid-cols-2 gap-6\">\n                    <div class=\"bg-white rounded-lg shadow-md p-6\">\n                        <h3 class=\"text-xl font-bold mb-4\">\n                            <i class=\"fas fa-plus-circle mr-2 text-green-600\"></i>\n                            Book a Ride\n                        </h3>\n                        <form id=\"bookingForm\" class=\"space-y-4\">\n                            <div>\n                                <label class=\"block text-sm font-medium text-gray-700 mb-1\">Route</label>\n                                <select id=\"routeSelect\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\" required>\n                                    <option value=\"\">Select Route</option>\n                                </select>\n                            </div>\n                            <div>\n                                <label class=\"block text-sm font-medium text-gray-700 mb-1\">Stop</label>\n                                <select id=\"stopSelect\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\" required disabled>\n                                    <option value=\"\">Select Stop</option>\n                                </select>\n                            </div>\n                            <div>\n                                <label class=\"block text-sm font-medium text-gray-700 mb-1\">Date</label>\n                                <input type=\"date\" id=\"bookingDate\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\" required />\n                            </div>\n                            <div>\n                                <label class=\"block text-sm font-medium text-gray-700 mb-1\">Time</label>\n                                <select id=\"timeSelect\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\" required>\n                                    <option value=\"true\">Morning (Pick-up)</option>\n                                    <option value=\"false\">Afternoon (Drop-off)</option>\n                                </select>\n                            </div>\n                            <div>\n                                <label class=\"block text-sm font-medium text-gray-700 mb-1\">Special Instructions</label>\n                                <textarea id=\"instructions\" class=\"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\" rows=\"3\" placeholder=\"Any special instructions...\"></textarea>\n                            </div>\n                            <button type=\"submit\" class=\"w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700\">\n                                Book Ride\n                            </button>\n                        </form>\n                    </div>\n\n                    <div class=\"bg-white rounded-lg shadow-md p-6\">\n                        <h3 class=\"text-xl font-bold mb-4\">\n                            <i class=\"fas fa-list mr-2 text-blue-600\"></i>\n                            My Bookings\n                        </h3>\n                        <div id=\"bookingsList\" class=\"space-y-3\">\n                            <p class=\"text-gray-500 text-center py-8\">No bookings found</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </main>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js\"></script>\n    <script src=\"/static/app.js\"></script>\n</body>\n</html>`)\n})\n\nexport default app